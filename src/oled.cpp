#include "oled.h"

// ===== Heart Icons (40x40 normal, 56x56 for beat) =====
// Normal heart (40x40)
const unsigned char heart_small[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x07, 0xe0, 0x00, 0x01, 0xff,
  0x8f, 0xf8, 0x00, 0x03, 0xff, 0xdf, 0xfc, 0x00, 0x07, 0xff, 0xff, 0xfe,
  0x00, 0x0f, 0xff, 0xff, 0xff, 0x00, 0x1f, 0xff, 0xff, 0xff, 0x80, 0x3f,
  0xff, 0xff, 0xff, 0xc0, 0x3f, 0xff, 0xff, 0xff, 0xc0, 0x7f, 0xff, 0xff,
  0xff, 0xe0, 0x7f, 0xff, 0xff, 0xff, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xf0,
  0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff,
  0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff,
  0xf0, 0x7f, 0xff, 0xff, 0xff, 0xe0, 0x7f, 0xff, 0xff, 0xff, 0xe0, 0x3f,
  0xff, 0xff, 0xff, 0xc0, 0x3f, 0xff, 0xff, 0xff, 0xc0, 0x1f, 0xff, 0xff,
  0xff, 0x80, 0x0f, 0xff, 0xff, 0xff, 0x00, 0x07, 0xff, 0xff, 0xfe, 0x00,
  0x03, 0xff, 0xff, 0xfc, 0x00, 0x01, 0xff, 0xff, 0xf8, 0x00, 0x00, 0xff,
  0xff, 0xf0, 0x00, 0x00, 0x7f, 0xff, 0xe0, 0x00, 0x00, 0x3f, 0xff, 0xc0,
  0x00, 0x00, 0x1f, 0xff, 0x80, 0x00, 0x00, 0x0f, 0xff, 0x00, 0x00, 0x00,
  0x07, 0xfe, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x00, 0x00, 0x00, 0x01, 0xf8,
  0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Large heart (56x56)
const unsigned char heart_large[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf8, 0x1f, 0xc0,
  0x00, 0x00, 0x00, 0x0f, 0xfe, 0x7f, 0xf0, 0x00, 0x00, 0x00, 0x3f, 0xff,
  0xff, 0xfc, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00,
  0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0x80,
  0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x07, 0xff, 0xff, 0xff,
  0xff, 0xe0, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x0f, 0xff,
  0xff, 0xff, 0xff, 0xf0, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
  0x1f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff,
  0xfc, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x7f, 0xff, 0xff,
  0xff, 0xff, 0xfe, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x7f,
  0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe,
  0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x7f, 0xff, 0xff, 0xff,
  0xff, 0xfe, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x3f, 0xff,
  0xff, 0xff, 0xff, 0xfc, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
  0x1f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff,
  0xf0, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x07, 0xff, 0xff,
  0xff, 0xff, 0xe0, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x01,
  0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00,
  0x00, 0x00, 0x7f, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff,
  0xfc, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x0f,
  0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xe0, 0x00, 0x00,
  0x00, 0x03, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0x80,
  0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f,
  0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xfc, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x1f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xf0, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc0,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

OLED::OLED() {
    tft = new Adafruit_ST7789(TFT_CS, TFT_DC, TFT_RST);
    heartBig = false;
    lastHeartBeat = 0;
    lastDisplayedBPM = -1;
    lastFingerState = true;  // Assume finger present initially to avoid flash
}

void OLED::begin() {
    SPI.begin(TFT_SCLK, TFT_MISO, TFT_MOSI);
    
    pinMode(TFT_BACKLIGHT, OUTPUT);
    digitalWrite(TFT_BACKLIGHT, HIGH);
    
    tft->init(240, 240);
    tft->setRotation(0);
    tft->fillScreen(ST77XX_BLACK);
    tft->setTextColor(ST77XX_WHITE);
    tft->setTextWrap(true);
}

void OLED::clear() {
    tft->fillScreen(ST77XX_BLACK);
}

void OLED::setBrightness(bool on) {
    digitalWrite(TFT_BACKLIGHT, on ? HIGH : LOW);
}

void OLED::showInitScreen(const char* title) {
    clear();
    
    // Draw title
    tft->setTextSize(3);
    tft->setTextColor(ST77XX_RED);
    tft->setCursor(20, 15);
    tft->println(title);
    
    // Draw initial heart
    drawHeart(false);
    
    // Initial status
    tft->setTextSize(2);
    tft->setTextColor(ST77XX_YELLOW);
    tft->setCursor(30, 140);
    tft->print("Initializing...");
}

void OLED::drawHeart(bool big) {
    // Clear heart area (larger area for bigger hearts)
    tft->fillRect(80, 55, 80, 65, ST77XX_BLACK);
    
    if (big) {
        // Draw large heart 56x56 (centered)
        tft->drawBitmap(92, 57, heart_large, 56, 56, ST77XX_RED);
    } else {
        // Draw normal heart 40x40 (centered)
        tft->drawBitmap(100, 65, heart_small, 40, 40, ST77XX_RED);
    }
}

void OLED::triggerHeartBeat() {
    heartBig = true;
    lastHeartBeat = millis();
    drawHeart(true);
}

void OLED::updateHeartAnimation() {
    if (heartBig && (millis() - lastHeartBeat > HEART_BEAT_DURATION)) {
        heartBig = false;
        drawHeart(false);
    }
}

void OLED::updateStatus(float bpm, int avgBpm, long irValue, bool fingerDetected) {
    // Update heart animation
    updateHeartAnimation();
    
    // Check if we need to update the display
    int currentBPM = (int)bpm;
    bool needsUpdate = false;
    
    if (currentBPM != lastDisplayedBPM) needsUpdate = true;
    if (fingerDetected != lastFingerState) needsUpdate = true;
    
    if (!needsUpdate) return;
    
    lastDisplayedBPM = currentBPM;
    lastFingerState = fingerDetected;
    
    // Clear BPM area
    tft->fillRect(0, 120, 240, 120, ST77XX_BLACK);
    
    if (!fingerDetected) {
        // No finger detected
        tft->setTextSize(2);
        tft->setTextColor(ST77XX_YELLOW);
        tft->setCursor(30, 140);
        tft->print("Place finger");
        tft->setCursor(40, 165);
        tft->print("on sensor");
        
        // Draw empty heart
        drawHeart(false);
    } else if (bpm <= 0) {
        // Measuring
        tft->setTextSize(2);
        tft->setTextColor(ST77XX_CYAN);
        tft->setCursor(50, 150);
        tft->print("Measuring...");
        
        drawHeart(false);
    } else {
        // Show BPM
        tft->setTextSize(5);
        tft->setTextColor(ST77XX_WHITE);
        
        // Center the BPM value
        int xPos = 70;
        if (currentBPM < 100) xPos = 85;
        
        tft->setCursor(xPos, 140);
        tft->print(currentBPM);
        
        // BPM label
        tft->setTextSize(2);
        tft->setTextColor(ST77XX_GREEN);
        tft->setCursor(90, 190);
        tft->print("BPM");
        
        // Show Avg below
        tft->setTextColor(ST77XX_CYAN);
        tft->setCursor(70, 215);
        tft->print("Avg: ");
        tft->print(avgBpm);
    }
}

void OLED::showText(int x, int y, const char* text, uint16_t color, uint8_t size) {
    tft->setCursor(x, y);
    tft->setTextSize(size);
    tft->setTextColor(color);
    tft->println(text);
}

void OLED::clearArea(int x, int y, int width, int height) {
    tft->fillRect(x, y, width, height, ST77XX_BLACK);
}
